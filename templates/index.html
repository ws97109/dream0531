{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-8 offset-lg-2">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h2 class="card-title mb-0">å¤¢å¢ƒåˆ†æèˆ‡è¦–è¦ºåŒ–</h2>
            </div>
            <div class="card-body">
                <div class="input-section">
                    <form id="dream-form">
                        <div class="mb-3">
                            <label for="dream-input" class="form-label">è«‹è¼¸å…¥æ‚¨çš„å¤¢å¢ƒç‰‡æ®µï¼š</label>
                            <textarea id="dream-input" name="dream" class="form-control" 
                                rows="5" placeholder="ä¾‹å¦‚ï¼šæˆ‘å¤¢è¦‹è‡ªå·±åœ¨é£›è¡Œï¼Œä¸‹æ–¹æ˜¯ä¸€ç‰‡æ¹›è—çš„å¤§æµ·ï¼Œçªç„¶çœ‹åˆ°ä¸€åº§é–ƒé–ƒç™¼å…‰çš„åŸå ¡..." required></textarea>
                            <div class="form-text" id="char-count">0 å€‹å­—</div>
                        </div>
                        
                        <!-- å½±ç‰‡ç”Ÿæˆè¨­å®šå€å¡Š -->
                        <div class="mb-3">
                            <div class="card border-info">
                                <div class="card-body">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" value="" id="generate-video-checkbox">
                                        <label class="form-check-label" for="generate-video-checkbox">
                                            ğŸ¬ <strong>ç”Ÿæˆå¤¢å¢ƒå½±ç‰‡</strong>ï¼ˆéœ€è¦é¡å¤– 1-5 åˆ†é˜ï¼‰
                                        </label>
                                    </div>
                                    
                                    <!-- å½±ç‰‡è¨­å®šé¸é … -->
                                    <div id="video-settings" style="display: none;">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label for="video-length" class="form-label">å½±ç‰‡é•·åº¦ï¼š<span id="video-length-display">5</span> ç§’</label>
                                                <input type="range" class="form-range" id="video-length" min="3" max="15" value="5" step="1">
                                                <div class="form-text">
                                                    <small>
                                                        <span class="text-success">3-5ç§’ï¼šå¿«é€Ÿé è¦½</span> | 
                                                        <span class="text-warning">6-10ç§’ï¼šæ¨™æº–é•·åº¦</span> | 
                                                        <span class="text-danger">11-15ç§’ï¼šé«˜è³ªé‡ï¼ˆè¼ƒæ…¢ï¼‰</span>
                                                    </small>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="video-quality" class="form-label">å½±ç‰‡å“è³ª</label>
                                                <select class="form-select" id="video-quality">
                                                    <option value="fast">å¿«é€Ÿæ¨¡å¼ï¼ˆè¼ƒä½å“è³ªï¼‰</option>
                                                    <option value="standard" selected>æ¨™æº–æ¨¡å¼ï¼ˆå¹³è¡¡ï¼‰</option>
                                                    <option value="high">é«˜å“è³ªæ¨¡å¼ï¼ˆè¼ƒæ…¢ï¼‰</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <!-- é ä¼°æ™‚é–“é¡¯ç¤º -->
                                        <div class="mt-3">
                                            <div class="alert alert-info">
                                                <i class="bi bi-clock"></i> 
                                                <strong>é ä¼°ç”Ÿæˆæ™‚é–“ï¼š</strong>
                                                <span id="estimated-time">ç´„ 2-3 åˆ†é˜</span>
                                                <br>
                                                <small class="text-muted">å¯¦éš›æ™‚é–“å–æ±ºæ–¼æ‚¨çš„ GPU æ•ˆèƒ½</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary" id="analyze-btn">é–‹å§‹åˆ†æ</button>
                        </div>
                    </form>
                </div>
                
                <div class="loading mt-4" id="loading" style="display: none;">
                    <div class="text-center mb-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">è™•ç†ä¸­...</span>
                        </div>
                    </div>
                    <p class="text-center" id="process-status">æ­£åœ¨åˆ†æå¤¢å¢ƒå…ƒç´ ...</p>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" id="progress-bar" role="progressbar" style="width: 0%;" 
                            aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <p class="text-center text-muted mt-2 small" id="process-detail">åˆ†æå¤¢å¢ƒå…ƒç´ ä¸¦å‰µå»ºæ•…äº‹æ¶æ§‹...</p>
                </div>
                
                <div class="alert alert-danger mt-3" id="error-message" style="display: none;"></div>
            </div>
        </div>
        
        <div class="results-section mt-4" id="results" style="display: none;">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">å¤¢å¢ƒæ•…äº‹</h5>
                </div>
                <div class="card-body">
                    <p id="final-story"></p>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">è¦–è¦ºåŒ–å¤¢å¢ƒ</h5>
                        </div>
                        <div class="card-body text-center">
                            <img id="dream-image" class="img-fluid rounded" src="" alt="è¦–è¦ºåŒ–å¤¢å¢ƒåœ–åƒ">
                            <div class="text-muted small mt-2">ç”± Stable Diffusion ç”Ÿæˆ</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">å¤¢å¢ƒå¿ƒç†åˆ†æ</h5>
                        </div>
                        <div class="card-body">
                            <p id="psychology-analysis"></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-12" id="video-section" style="display: none;">
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">ğŸ¬ å¤¢å¢ƒå½±ç‰‡ <span id="video-info-badge" class="badge bg-light text-dark ms-2"></span></h5>
                    </div>
                    <div class="card-body text-center">
                        <video id="dream-video" class="img-fluid rounded" controls style="max-width: 100%; max-height: 400px;">
                            æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ’­æ”¾
                        </video>
                        <div class="text-muted small mt-2">ç”± FramePack ç”Ÿæˆ</div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mb-4">
                <button id="restart-btn" class="btn btn-primary">é‡æ–°é–‹å§‹</button>
                <button id="share-btn" class="btn btn-success ms-2">åˆ†äº«çµæœ</button>
            </div>
        </div>
    </div>
</div>

<!-- åˆ†äº«æ¨¡æ…‹æ¡† -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareModalLabel">åˆ†äº«æ‚¨çš„å¤¢å¢ƒåˆ†æçµæœ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="share-link" class="form-label">åˆ†äº«é€£çµ</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="share-link" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="copy-link-btn">è¤‡è£½</button>
                    </div>
                </div>
                <div class="d-grid gap-2 mt-3">
                    <button type="button" class="btn btn-primary" id="share-facebook-btn">
                        <i class="bi bi-facebook"></i> åˆ†äº«åˆ° Facebook
                    </button>
                    <button type="button" class="btn btn-info text-white" id="share-twitter-btn">
                        <i class="bi bi-twitter"></i> åˆ†äº«åˆ° Twitter
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        const dreamInput = $('#dream-input');
        const dreamForm = $('#dream-form');
        const analyzeBtn = $('#analyze-btn');
        const loading = $('#loading');
        const results = $('#results');
        const charCount = $('#char-count');
        const processStatus = $('#process-status');
        const processDetail = $('#process-detail');
        const progressBar = $('#progress-bar');
        const errorMessage = $('#error-message');
        const restartBtn = $('#restart-btn');
        const shareBtn = $('#share-btn');
        const copyLinkBtn = $('#copy-link-btn');
        const shareFacebookBtn = $('#share-facebook-btn');
        const shareTwitterBtn = $('#share-twitter-btn');
        const generateVideoCheckbox = $('#generate-video-checkbox');
        const videoSettings = $('#video-settings');
        const videoLengthSlider = $('#video-length');
        const videoLengthDisplay = $('#video-length-display');
        const videoQualitySelect = $('#video-quality');
        const estimatedTimeSpan = $('#estimated-time');
        
        // é˜²é‡è¤‡æäº¤ç‹€æ…‹
        let isProcessing = false;
        
        // å½±ç‰‡è¨­å®šç›¸é—œäº‹ä»¶
        generateVideoCheckbox.on('change', function() {
            if (this.checked) {
                videoSettings.slideDown();
                updateEstimatedTime();
            } else {
                videoSettings.slideUp();
            }
        });
        
        // å½±ç‰‡é•·åº¦æ»‘æ¡¿äº‹ä»¶
        videoLengthSlider.on('input', function() {
            const length = $(this).val();
            videoLengthDisplay.text(length);
            updateEstimatedTime();
        });
        
        // å½±ç‰‡å“è³ªé¸æ“‡äº‹ä»¶
        videoQualitySelect.on('change', function() {
            updateEstimatedTime();
        });
        
        // æ›´æ–°é ä¼°æ™‚é–“
        function updateEstimatedTime() {
            const length = parseInt(videoLengthSlider.val());
            const quality = videoQualitySelect.val();
            
            let baseTime = length; // åŸºç¤æ™‚é–“ï¼ˆç§’ï¼‰
            let multiplier = 1;
            
            // æ ¹æ“šå“è³ªèª¿æ•´å€æ•¸
            switch(quality) {
                case 'fast':
                    multiplier = 0.7;
                    break;
                case 'standard':
                    multiplier = 1.0;
                    break;
                case 'high':
                    multiplier = 1.5;
                    break;
            }
            
            const estimatedMinutes = Math.ceil((baseTime * multiplier * 15) / 60); // å‡è¨­æ¯ç§’éœ€è¦15ç§’è™•ç†æ™‚é–“
            const minTime = Math.max(1, Math.floor(estimatedMinutes * 0.8));
            const maxTime = Math.ceil(estimatedMinutes * 1.2);
            
            estimatedTimeSpan.text(`ç´„ ${minTime}-${maxTime} åˆ†é˜`);
        }
        
        // è™•ç†é€²åº¦çš„æ­¥é©Ÿï¼ˆæ ¹æ“šæ˜¯å¦ç”Ÿæˆå½±ç‰‡å’Œè¨­å®šå‹•æ…‹èª¿æ•´ï¼‰
        function getSteps(includeVideo, videoLength, videoQuality) {
            const baseSteps = [
                { status: 'æ­£åœ¨åˆ†æå¤¢å¢ƒå…ƒç´ ...', detail: 'è­˜åˆ¥é—œéµå…ƒç´ èˆ‡è±¡å¾µæ„ç¾©', progress: 10 },
                { status: 'æ­£åœ¨å‰µä½œå¤¢å¢ƒæ•…äº‹...', detail: 'èåˆå¤¢å¢ƒå…ƒç´ å‰µä½œå®Œæ•´æ•…äº‹', progress: 25 },
                { status: 'æ­£åœ¨ç”Ÿæˆè¦–è¦ºåœ–åƒ...', detail: 'ä½¿ç”¨ Stable Diffusion å‰µå»ºå¤¢å¢ƒè¦–è¦ºåŒ–åœ–åƒ', progress: includeVideo ? 45 : 70 }
            ];
            
            if (includeVideo) {
                const videoProgressStart = 50;
                const videoProgressEnd = 85;
                
                baseSteps.push({ 
                    status: `æ­£åœ¨ç”Ÿæˆ ${videoLength} ç§’å¤¢å¢ƒå½±ç‰‡...`, 
                    detail: `${videoQuality === 'high' ? 'é«˜å“è³ª' : videoQuality === 'fast' ? 'å¿«é€Ÿ' : 'æ¨™æº–'}æ¨¡å¼ç”Ÿæˆä¸­ï¼Œè«‹è€å¿ƒç­‰å€™`, 
                    progress: videoProgressStart 
                });
                
                // æ ¹æ“šå½±ç‰‡é•·åº¦æ·»åŠ æ›´å¤šé€²åº¦æ­¥é©Ÿ
                if (videoLength > 8) {
                    baseSteps.push({ 
                        status: 'å½±ç‰‡ç”Ÿæˆé€²è¡Œä¸­...', 
                        detail: 'æ­£åœ¨è™•ç†è¤‡é›œå ´æ™¯å‹•ç•«', 
                        progress: videoProgressEnd - 10 
                    });
                }
            }
            
            baseSteps.push(
                { status: 'æ­£åœ¨é€²è¡Œå¿ƒç†åˆ†æ...', detail: 'æ ¹æ“šå¤¢å¢ƒå…§å®¹é€²è¡Œæ·±åº¦åˆ†æ', progress: 95 },
                { status: 'å®Œæˆï¼', detail: 'æ‚¨çš„å¤¢å¢ƒåˆ†æçµæœå·²ç¶“æº–å‚™å¥½', progress: 100 }
            );
            
            return baseSteps;
        }
        
        // å­—æ•¸è¨ˆç®—
        dreamInput.on('input', function() {
            const count = dreamInput.val().length;
            charCount.text(count + ' å€‹å­—');
        });
        
        // è¡¨å–®æäº¤
        dreamForm.on('submit', function(e) {
            e.preventDefault();
            
            const dreamText = dreamInput.val().trim();
            const generateVideo = generateVideoCheckbox.is(':checked');
            const videoLength = parseInt(videoLengthSlider.val());
            const videoQuality = videoQualitySelect.val();
            
            // åŸºæœ¬é©—è­‰
            if (dreamText.length < 10) {
                errorMessage.text('è«‹è¼¸å…¥è‡³å°‘10å€‹å­—çš„å¤¢å¢ƒæè¿°');
                errorMessage.show();
                return;
            }
            
            // ç°¡å–®çš„é‡è¤‡æäº¤æª¢æŸ¥
            if (analyzeBtn.prop('disabled')) {
                return;
            }
            
            // éš±è—éŒ¯èª¤è¨Šæ¯
            errorMessage.hide();
            
            // ç¦ç”¨æäº¤æŒ‰éˆ•ä¸¦æ”¹è®Šæ–‡å­—
            analyzeBtn.prop('disabled', true);
            if (generateVideo) {
                analyzeBtn.text(`åˆ†æä¸¦ç”Ÿæˆ ${videoLength} ç§’å½±ç‰‡ä¸­...`);
            } else {
                analyzeBtn.text('åˆ†æä¸­...');
            }
            
            // é¡¯ç¤ºè¼‰å…¥ä¸­
            loading.show();
            results.hide();
            
            // é‡ç½®é€²åº¦æ¢
            progressBar.css('width', '0%');
            progressBar.attr('aria-valuenow', 0);
            
            const steps = getSteps(generateVideo, videoLength, videoQuality);
            processDetail.text(steps[0].detail);
            
            // ä½¿ç”¨AJAXç™¼é€è«‹æ±‚
            processDream(dreamText, generateVideo, videoLength, videoQuality);
        });
        
        // é‡æ–°é–‹å§‹æŒ‰éˆ•
        restartBtn.on('click', function() {
            // é‡ç½®ç‹€æ…‹
            analyzeBtn.prop('disabled', false);
            analyzeBtn.text('é–‹å§‹åˆ†æ');
            
            results.hide();
            dreamInput.val('');
            charCount.text('0 å€‹å­—');
            errorMessage.hide();
            generateVideoCheckbox.prop('checked', false);
            videoSettings.hide();
            videoLengthSlider.val(5);
            videoLengthDisplay.text('5');
            videoQualitySelect.val('standard');
            updateEstimatedTime();
            $('#video-section').hide();
            dreamInput.focus();
        });
        
        // åˆ†äº«æŒ‰éˆ•
        shareBtn.on('click', function() {
            // æº–å‚™åˆ†äº«æ•¸æ“š
            const shareData = {
                finalStory: $('#final-story').text(),
                imagePath: $('#dream-image').attr('src'),
                videoPath: $('#dream-video').attr('src') || null,
                psychologyAnalysis: $('#psychology-analysis').text()
            };
            
            // ç™¼é€åˆ†äº«è«‹æ±‚
            $.ajax({
                url: '/api/share',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(shareData),
                success: function(response) {
                    $('#share-link').val(response.shareUrl);
                    var shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
                    shareModal.show();
                },
                error: function() {
                    alert('å‰µå»ºåˆ†äº«é€£çµå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            });
        });
        
        // è¤‡è£½é€£çµ
        copyLinkBtn.on('click', function() {
            const shareLink = $('#share-link');
            shareLink.select();
            document.execCommand('copy');
            
            // é¡¯ç¤ºè¤‡è£½æˆåŠŸ
            copyLinkBtn.text('å·²è¤‡è£½!');
            setTimeout(function() {
                copyLinkBtn.text('è¤‡è£½');
            }, 2000);
        });
        
        // ç¤¾äº¤åª’é«”åˆ†äº«æŒ‰éˆ•
        shareFacebookBtn.on('click', function() {
            const shareUrl = $('#share-link').val();
            window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(shareUrl), '_blank');
        });
        
        shareTwitterBtn.on('click', function() {
            const shareUrl = $('#share-link').val();
            const shareText = 'æˆ‘å‰›å‰›ä½¿ç”¨å¤¢å¢ƒåˆ†æç³»çµ±åˆ†æäº†æˆ‘çš„å¤¢å¢ƒï¼Œçœ‹çœ‹çµæœï¼';
            window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(shareText) + '&url=' + encodeURIComponent(shareUrl), '_blank');
        });
        
        // è™•ç†å¤¢å¢ƒåˆ†æ
        function processDream(dreamText, generateVideo, videoLength, videoQuality) {
            const steps = getSteps(generateVideo, videoLength, videoQuality);
            
            // é€²åº¦æ›´æ–°
            let currentStep = 0;
            
            const progressInterval = setInterval(function() {
                if (currentStep >= steps.length) {
                    clearInterval(progressInterval);
                    return;
                }
                
                const step = steps[currentStep];
                processStatus.text(step.status);
                processDetail.text(step.detail);
                progressBar.css('width', step.progress + '%');
                progressBar.attr('aria-valuenow', step.progress);
                
                // æ ¹æ“šæ­¥é©Ÿé¡å‹èª¿æ•´ç­‰å¾…æ™‚é–“
                let waitTime = 1200;
                if (step.status.includes('ç”Ÿæˆè¦–è¦ºåœ–åƒ')) {
                    waitTime = 2000;
                } else if (step.status.includes('ç”Ÿæˆå¤¢å¢ƒå½±ç‰‡')) {
                    // æ ¹æ“šå½±ç‰‡é•·åº¦å’Œå“è³ªèª¿æ•´ç­‰å¾…æ™‚é–“
                    waitTime = Math.max(3000, videoLength * 500);
                    if (videoQuality === 'high') waitTime *= 1.5;
                    if (videoQuality === 'fast') waitTime *= 0.7;
                }
                
                setTimeout(function() {
                    currentStep++;
                }, waitTime);
            }, 1200);
            
            // è¨ˆç®—è¶…æ™‚æ™‚é–“ï¼ˆæ ¹æ“šå½±ç‰‡è¨­å®šå‹•æ…‹èª¿æ•´ï¼‰
            let timeoutDuration = 180000; // åŸºç¤ 3 åˆ†é˜
            if (generateVideo) {
                timeoutDuration = Math.max(300000, videoLength * videoLength * 10000); // æœ€å°‘ 5 åˆ†é˜
                if (videoQuality === 'high') timeoutDuration *= 1.5;
            }
            
            // ç™¼é€APIè«‹æ±‚
            $.ajax({
                url: '/api/analyze',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ 
                    dream: dreamText,
                    generateVideo: generateVideo,
                    videoLength: videoLength,
                    videoQuality: videoQuality
                }),
                timeout: timeoutDuration,
                success: function(response) {
                    // ç¢ºä¿é€²åº¦æ¢èµ°å®Œ
                    setTimeout(function() {
                        clearInterval(progressInterval);
                        processStatus.text('å®Œæˆï¼');
                        processDetail.text('æ‚¨çš„å¤¢å¢ƒåˆ†æçµæœå·²ç¶“æº–å‚™å¥½');
                        progressBar.css('width', '100%');
                        progressBar.attr('aria-valuenow', 100);
                        
                        // é¡¯ç¤ºçµæœ
                        displayResults(response);
                        
                        // éš±è—è¼‰å…¥ä¸­ä¸¦æ¢å¾©ç‹€æ…‹
                        setTimeout(function() {
                            loading.hide();
                            results.show();
                            // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                            analyzeBtn.prop('disabled', false);
                            analyzeBtn.text('é–‹å§‹åˆ†æ');
                        }, 500);
                    }, Math.max(0, steps.length * 1200 - 1200));
                },
                error: function(xhr, status, error) {
                    clearInterval(progressInterval);
                    loading.hide();
                    
                    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                    analyzeBtn.prop('disabled', false);
                    analyzeBtn.text('é–‹å§‹åˆ†æ');
                    
                    let errorMsg = 'è™•ç†è«‹æ±‚æ™‚ç™¼ç”ŸéŒ¯èª¤';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    } else if (status === 'timeout') {
                        errorMsg = 'è«‹æ±‚è¶…æ™‚ï¼Œè«‹å˜—è©¦ç¸®çŸ­å½±ç‰‡é•·åº¦æˆ–ä½¿ç”¨å¿«é€Ÿæ¨¡å¼';
                    }
                    
                    errorMessage.text(errorMsg);
                    errorMessage.show();
                }
            });
        }
        
        // é¡¯ç¤ºçµæœ
        function displayResults(data) {
            // å¡«å……å®Œæ•´æ•…äº‹ã€åœ–åƒå’Œå¿ƒç†åˆ†æ
            $('#final-story').text(data.finalStory);
            $('#psychology-analysis').text(data.psychologyAnalysis);
            
            // è¨­ç½®åœ–åƒ
            if (data.imagePath) {
                $('#dream-image').attr('src', data.imagePath);
                $('#dream-image').attr('alt', 'å¤¢å¢ƒè¦–è¦ºåŒ–åœ–åƒ');
            } else {
                $('#dream-image').attr('src', '/static/images/default_dream.png');
                $('#dream-image').attr('alt', 'æœªèƒ½ç”Ÿæˆå¤¢å¢ƒåœ–åƒ');
            }
            
            // è¨­ç½®å½±ç‰‡
            if (data.videoPath) {
                $('#dream-video').attr('src', data.videoPath);
                $('#video-section').show();
                
                // é¡¯ç¤ºå½±ç‰‡è³‡è¨Šå¾½ç« 
                if (data.processingInfo && data.processingInfo.videoInfo) {
                    const videoInfo = data.processingInfo.videoInfo;
                    $('#video-info-badge').text(`${videoInfo.length}ç§’ | ${videoInfo.quality}å“è³ª`);
                }
                
                console.log('âœ… å½±ç‰‡é¡¯ç¤ºæˆåŠŸ:', data.videoPath);
            } else {
                $('#video-section').hide();
                console.log('âš ï¸ æ²’æœ‰å½±ç‰‡è·¯å¾‘');
            }
            
            // è¼¸å‡ºè™•ç†è³‡è¨Šï¼ˆç”¨æ–¼èª¿è©¦ï¼‰
            if (data.processingInfo) {
                console.log('è™•ç†è³‡è¨Š:', data.processingInfo);
                if (data.processingInfo.videoGenerated) {
                    console.log('âœ… å½±ç‰‡ç”ŸæˆæˆåŠŸ');
                } else {
                    console.log('âš ï¸ å½±ç‰‡æœªç”Ÿæˆ');
                }
            }
        }
        
        // åˆå§‹åŒ–æ™‚æ›´æ–°é ä¼°æ™‚é–“
        updateEstimatedTime();
    });
</script>
{% endblock %}